<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">
	 <!-- 
	 <resultMap type="web.board.model.BoardVO" id="resultBoardVO">
			<result property="bno" column="BNO" /> 					게시판 번호
			<result property="title" column="TITLE" /> 				게시판 제목
			<result property="content" column="CONTENT" /> 			게시판 내용
			<result property="writer" column="WRITER" /> 			게시판 작가
			<result property="regdate" column="REGDATE" /> 			등록 날짜  
			<result property="updateDate" column="UPDATEDATE" /> 	수정 날짜
	</resultMap> 
	-->
	
	<!-- 게시판 목록조회 -->
	<select id="getList" resultType="web.board.model.BoardVO">
		<!-- SELECT ROWNUM, BNO, TITLE, WRITER, CONTENT 
		FROM YUNBOARD  -->
		SELECT ROWNUM, BNO, TITLE, WRITER, CONTENT
		FROM YUNBOARD B 
	</select>
	
	<!-- 게시판 목록(페이징) -->
	<select id="getListPaging" resultType="web.board.model.BoardVO">
	  <!--   <![CDATA[
	        SELECT ROWNUM, BNO, TITLE, CONTENT, WRITER, REGDATE, UPDATEDATE FROM(	        
	                SELECT /*+INDEX_DESC(YUNBOARD pk_board1) */ ROWNUM  as rn, 
	                       BNO, TITLE, CONTENT, WRITER, REGDATE, UPDATEDATE	                  
	                FROM YUNBOARD where ROWNUM <= #{pageNum} * #{amount}) 	                
	        WHERE rn > (#{pageNum} -1) * #{amount}
	        ORDER BY ROWNUM DESC
	    ]]>  -->   
	    <![CDATA[
	    	SELECT ROWNUM , BNO,TITLE, CONTENT, WRITER, REGDATE, UPDATEDATE,
	    	       (SELECT COUNT(*)
					FROM YUN_REPLY R
					WHERE R.BNO  = B.BNO ) AS repCount  	
			FROM YUNBOARD B ORDER BY BNO DESC offset (#{pageNum}-1)*10 ROWS FETCH NEXT #{amount} ROWS ONLY		
	    ]]>
	     
    </select>
    
    <!-- 게시판 총 개수 -->
    <select id="getTotal" resultType="int">
    	SELECT COUNT(*) FROM YUNBOARD
    </select>
	
	<!-- 게시판 등록 -->
	<insert id="insertBoard" useGeneratedKeys="true" keyProperty="bno">
		<selectKey keyProperty="bno" resultType="int" order="BEFORE">
	    	SELECT BOARD_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
		INSERT INTO YUNBOARD (BNO, TITLE, WRITER, CONTENT) 
		VALUES (#{bno}, #{title}, #{writer}, #{content})
	</insert>
	
	<!-- 게시판 상세조회 -->
	<select id="getPage" resultType="web.board.model.BoardVO">
		SELECT * 
		FROM YUNBOARD 
		WHERE BNO = #{bno}
	</select>

	<!-- 첨부파일 업로드 -->
	<insert id="insertFile" parameterType="hashMap">
		INSERT INTO YUN_FILE(FILE_NO, BNO, ORG_FILE_NAME, STORED_FILE_NAME, FILE_SIZE)
			VALUES(SEQ_YUN_FILE_NO.NEXTVAL, #{BNO}, #{ORG_FILE_NAME}, #{STORED_FILE_NAME}, #{FILE_SIZE} )
	</insert>
	<!-- 첨부파일 조회 -->
	<select id="selectFileList" parameterType="int" resultType="hashMap">
		SELECT FILE_NO, ORG_FILE_NAME, ROUND(FILE_SIZE/1024,1) AS FILE_SIZE
        FROM YUN_FILE
        WHERE BNO = #{BNO}
        AND DEL_GB = 'N'
        ORDER BY FILE_NO ASC
	</select>
	<!-- 첨부파일 다운 -->
	<select id="selectFileInfo" parameterType="hashMap" resultType="hashMap">
		SELECT STORED_FILE_NAME, ORG_FILE_NAME
		FROM YUN_FILE 
		WHERE FILE_NO = #{FILE_NO}
	</select>
	<update id="updateFile" parameterType="hashMap">
		UPDATE YUN_FILE 
		SET DEL_GB = 'Y'
		WHERE FILE_NO = #{FILE_NO}
	</update>
	
	
	<!-- 게시판 수정 -->
	<update id="modify">
		UPDATE YUNBOARD 
		SET TITLE=#{title}, CONTENT=#{content}, UPDATEDATE= sysdate
		WHERE BNO=#{bno}
	</update>
	
	<!-- 게시판 삭제 -->
	<delete id="delete">
		DELETE FROM YUNBOARD WHERE BNO = #{bno}
	</delete>
</mapper>